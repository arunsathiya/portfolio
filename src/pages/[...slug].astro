---
import { Image } from 'astro:assets';
import { type CollectionEntry, getCollection } from 'astro:content';
import { getTagBackgroundColor } from '@src/utils/tagColors';
import { loadEnv } from 'vite';
import FormattedDate from '../components/FormattedDate.astro';
import Prose from '../components/Prose.astro';
import TableOfContent from '../components/widgets/TableOfContent.astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import { slugify } from '../utils';

export const prerender = true;

const { GISCUS_REPO, GISCUS_REPO_ID, GISCUS_CATEGORY, GISCUS_CATEGORY_ID } = loadEnv(
	process.env.NODE_ENV || 'production',
	process.cwd(),
	'',
);

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post: CollectionEntry<'blog'>) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

type Props = {
	post: CollectionEntry<'blog'>;
};

const { slug } = Astro.params;
let { post } = Astro.props as Props;

if (Astro.props.post) {
	// Static mode: post is passed as a prop
	post = Astro.props.post;
} else {
	// Server mode: fetch the post
	const posts = await getCollection('blog');
	const foundPost = posts.find((p: CollectionEntry<'blog'>) => p.slug === slug);
	if (!foundPost) {
		return Astro.redirect('/404');
	}
	post = foundPost;
}

const {
	data: { title, seoTitle, description, coverImage, pubDate, updatedDate, tags },
} = post;
const { Content, headings } = await post.render();

const getTagClasses = (tag: string) => `
  rounded-2xl
  text-sm no-underline px-2 py-0.5
  transition-all duration-700
  hover:opacity-80
  ${getTagBackgroundColor(tag)}
  ${getTagBackgroundColor(tag).includes('dark:bg-') ? 'text-zinc-800 dark:text-zinc-200' : 'text-zinc-700 dark:text-zinc-300'}
`;
---

<BaseLayout title={seoTitle || title} description={description} image={coverImage?.src || undefined}>
	<div class='container'>
		<main class='overflow-hidden mx-auto max-w-4xl'>
			<article>
				<Prose>
					<div>
						<h1 class='!my-1 leading-tight'>{title}</h1>
						<div
							class='text-sm font-[500] mt-2 sm:mt-0 py-1 md:text-right flex flex-col sm:flex-row gap-3 sm:justify-between sm:items-center'
						>
							{
								(
									<div class='flex gap-2'>
										{(tags || [])?.map((tag: string) => (
											<a class={getTagClasses(tag)} href={`/tags/${slugify(tag)}`}>
												{tag}
											</a>
										))}
									</div>
								)
							}
							<div>
								{
									pubDate ? (
										<>
											Published on{' '}
											<strong>
												<FormattedDate date={pubDate} />
											</strong>
										</>
									) : (
										<>
											Published on{' '}
											<strong>
												<FormattedDate date={pubDate} />
											</strong>
										</>
									)
								}
							</div>
						</div>
					</div>
					<div class='py-3 overflow-hidden'>
						<script>
							import('@zachleat/snow-fall');
							import('@11ty/is-land/is-land.js');
						</script>
						{
							coverImage && !tags?.includes('Asides') && (
								<is-land on:media='(prefers-reduced-motion: no-preference)'>
									<snow-fall count='20'>
										<Image class='w-full m-0 lg:mb-2' src={coverImage} alt={title} loading='eager' />
									</snow-fall>
								</is-land>
							)
						}
					</div>
					<Content />
				</Prose>
			</article>

			<div class='mt-8 space-y-8'>
				<div class='mx-auto max-w-2xl'>{headings.length > 0 && <TableOfContent headings={headings} />}</div>

				<div class='mx-auto max-w-2xl'>
					{
						GISCUS_REPO && (
							<script
								id='giscus-script'
								is:inline
								src='https://giscus.app/client.js'
								data-repo={GISCUS_REPO}
								data-repo-id={GISCUS_REPO_ID}
								data-category={GISCUS_CATEGORY}
								data-category-id={GISCUS_CATEGORY_ID}
								data-mapping='pathname'
								data-strict='0'
								data-reactions-enabled='0'
								data-emit-metadata='0'
								data-input-position='bottom'
								data-theme='preferred_color_scheme'
								data-lang='en'
								crossorigin='anonymous'
								async
							/>
						)
					}
				</div>
			</div>
		</main>
	</div>
</BaseLayout>

<script async is:inline>
	const anchors = document.querySelectorAll('.prose h2[id], .prose h3[id]');
	const links = document.querySelectorAll('nav.toc ul li a');

	function observeToc() {
		if (typeof anchors != 'undefined' && anchors != null && typeof links != 'undefined' && links != null) {
			let scrollTop = window.scrollY;

			// highlight the last scrolled-to: set everything inactive first
			for (const link of links) {
				link.classList.add('border-transparent', 'text-inherit');
				link.classList.remove('bg-[var(--background-surface-color)]', 'border-[var(--soft-border-color)]', 'text-[var(--link-color)]');
			}
			// then iterate backwards, on the first match highlight it and break
			for (var i = anchors.length - 1; i >= 0; i--) {
				if (scrollTop > anchors[i].offsetTop - 80) {
					links[i].classList.remove('border-transparent', 'text-inherit');
					links[i].classList.add('bg-[var(--background-surface-color)]', 'border-[var(--soft-border-color)]', 'text-[var(--link-color)]');
					break;
				}
			}
		}
	}

	window.addEventListener('scroll', (event) => {
		observeToc(event);
	});
	window.addEventListener('hashchange', (event) => {
		observeToc(event);
	});
</script>
